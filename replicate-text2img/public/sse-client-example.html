<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本到图像 SSE 客户端示例</title>
  <style>
    body {
      font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #444;
    }
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    .input-row {
      display: flex;
      justify-content: space-between;
      gap: 15px;
    }
    .input-row .form-group {
      flex: 1;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .button-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    #statusPanel {
      margin-top: 30px;
      padding: 15px;
      background-color: #f9f9f9;
      border-left: 4px solid #3498db;
      border-radius: 4px;
    }
    #statusPanel.error {
      border-left-color: #e74c3c;
      background-color: #fdedec;
    }
    #statusPanel.success {
      border-left-color: #2ecc71;
      background-color: #eafaf1;
    }
    #statusTitle {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status-item {
      padding: 8px 10px;
      margin-bottom: 8px;
      border-left: 3px solid #ddd;
      background-color: white;
      border-radius: 3px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .status-item:last-child {
      margin-bottom: 0;
    }
    .status-item.highlight {
      border-left-color: #f39c12;
      background-color: #fef9e7;
    }
    .status-item .timestamp {
      font-size: 12px;
      color: #7f8c8d;
      margin-right: 10px;
    }
    .result-container {
      margin-top: 30px;
      display: none;
    }
    .result-container h2 {
      margin-bottom: 15px;
      color: #2c3e50;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      grid-gap: 15px;
    }
    .image-item {
      position: relative;
      overflow: hidden;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .image-item img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.3s;
    }
    .image-item:hover img {
      transform: scale(1.03);
    }
    .image-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.6);
      padding: 10px;
      display: flex;
      justify-content: space-between;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .image-item:hover .image-actions {
      opacity: 1;
    }
    .image-actions button {
      padding: 5px 10px;
      font-size: 12px;
    }
    .task-list {
      margin-top: 30px;
    }
    .task-list h2 {
      color: #2c3e50;
      margin-bottom: 15px;
    }
    .task-item {
      padding: 15px;
      background-color: white;
      border-radius: 4px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .task-id {
      font-size: 14px;
      color: #7f8c8d;
      font-family: monospace;
    }
    .task-status {
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-queued { background-color: #f1c40f; color: #fff; }
    .status-processing { background-color: #3498db; color: #fff; }
    .status-succeeded { background-color: #2ecc71; color: #fff; }
    .status-failed { background-color: #e74c3c; color: #fff; }
    .status-retrying { background-color: #e67e22; color: #fff; }
    .task-prompt {
      margin-bottom: 10px;
      color: #444;
      font-size: 14px;
    }
    .task-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    footer {
      margin-top: 40px;
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
    }
    @keyframes highlight {
      0% { background-color: transparent; }
      20% { background-color: #fff3cd; }
      100% { background-color: transparent; }
    }
    .highlight-animation {
      animation: highlight 2s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>文本到图像 SSE 客户端示例</h1>

    <div id="connectionStatus">
      <strong>SSE 连接状态：</strong> <span id="sseStatus">未连接</span>
      <button id="connectButton" style="margin-left: 10px;">连接 SSE</button>
    </div>
    
    <form id="generateForm">
      <div class="form-group">
        <label for="prompt">提示词：</label>
        <textarea id="prompt" name="prompt" required placeholder="描述你想生成的图像，例如：高清动漫风景，樱花树下的日本传统神社，黄昏时分，云彩，细节丰富"></textarea>
      </div>
      
      <div class="form-group">
        <label for="negative_prompt">负面提示词：</label>
        <textarea id="negative_prompt" name="negative_prompt" placeholder="描述你不想在图像中出现的内容，例如：nsfw, 低质量, 模糊, 畸形, 不完整">nsfw, 低质量, 模糊, 畸形, 不完整</textarea>
      </div>
      
      <div class="input-row">
        <div class="form-group">
          <label for="width">宽度：</label>
          <input type="number" id="width" name="width" value="1024" min="64" max="4096" step="64">
        </div>
        
        <div class="form-group">
          <label for="height">高度：</label>
          <input type="number" id="height" name="height" value="1024" min="64" max="4096" step="64">
        </div>
        
        <div class="form-group">
          <label for="steps">步数：</label>
          <input type="number" id="steps" name="steps" value="28" min="1" max="100">
        </div>
        
        <div class="form-group">
          <label for="batch_size">批量大小：</label>
          <input type="number" id="batch_size" name="batch_size" value="1" min="1" max="4">
        </div>
      </div>

      <div class="form-group" id="retrySection" style="display: none;">
        <label for="taskId">任务 ID（重试用）：</label>
        <input type="text" id="taskId" name="taskId" placeholder="输入需要重试的任务ID">
      </div>
      
      <div class="button-row">
        <button type="button" id="toggleRetryButton">切换到重试模式</button>
        <button type="submit" id="submitButton">生成图像</button>
      </div>
    </form>
    
    <div id="statusPanel">
      <div id="statusTitle">任务状态更新：</div>
      <div id="statusContent"></div>
    </div>
    
    <div class="result-container" id="resultContainer">
      <h2>生成结果</h2>
      <div class="image-grid" id="imageGrid"></div>
    </div>
    
    <div class="task-list">
      <h2>任务历史</h2>
      <div id="taskHistory"></div>
    </div>
    
    <footer>
      <p>Replicate 文本到图像服务 | SSE 客户端示例 &copy; 2023</p>
    </footer>
  </div>

  <script src="../client/SSEClient.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 创建客户端实例
      const client = new Text2ImgEventClient({
        baseUrl: '',  // 如果在同一域名下运行，可以留空
        reconnectInterval: 2000,
        maxReconnectAttempts: 5
      });

      // 存储任务历史
      const taskHistory = new Map();
      
      // DOM 元素
      const connectButton = document.getElementById('connectButton');
      const sseStatus = document.getElementById('sseStatus');
      const generateForm = document.getElementById('generateForm');
      const toggleRetryButton = document.getElementById('toggleRetryButton');
      const submitButton = document.getElementById('submitButton');
      const retrySection = document.getElementById('retrySection');
      const statusContent = document.getElementById('statusContent');
      const statusPanel = document.getElementById('statusPanel');
      const resultContainer = document.getElementById('resultContainer');
      const imageGrid = document.getElementById('imageGrid');
      const taskHistoryElement = document.getElementById('taskHistory');
      
      // 是否处于重试模式
      let isRetryMode = false;
      
      // 连接 SSE
      connectButton.addEventListener('click', async () => {
        try {
          connectButton.disabled = true;
          sseStatus.textContent = '正在连接...';
          
          await client.connect();
          
          sseStatus.textContent = '已连接';
          sseStatus.style.color = 'green';
          connectButton.textContent = '重新连接';
          connectButton.disabled = false;
          
          // 添加状态更新
          addStatusItem('SSE 连接已成功建立', 'connected');
        } catch (error) {
          sseStatus.textContent = '连接失败';
          sseStatus.style.color = 'red';
          connectButton.disabled = false;
          
          // 添加状态更新
          addStatusItem(`SSE 连接失败: ${error.message}`, 'error');
        }
      });
      
      // 监听所有任务更新
      client.addEventListener('task_update', (data) => {
        console.log('收到任务更新:', data);
        
        // 添加状态更新
        addStatusItem(`任务 ${data.taskId} 状态: ${data.status}`, 'task_update', data);
        
        // 更新任务历史
        updateTaskHistory(data);
        
        // 如果任务成功完成
        if (data.status === 'succeeded' && data.urls && data.urls.length > 0) {
          // 显示结果
          showResults(data.urls, data.taskId);
        }
      });
      
      // 切换重试模式
      toggleRetryButton.addEventListener('click', () => {
        isRetryMode = !isRetryMode;
        
        if (isRetryMode) {
          retrySection.style.display = 'block';
          toggleRetryButton.textContent = '切换到生成模式';
          submitButton.textContent = '重试任务';
        } else {
          retrySection.style.display = 'none';
          toggleRetryButton.textContent = '切换到重试模式';
          submitButton.textContent = '生成图像';
        }
      });
      
      // 表单提交
      generateForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 禁用提交按钮
        submitButton.disabled = true;
        
        try {
          const formData = new FormData(generateForm);
          const params = {};
          
          for (const [key, value] of formData.entries()) {
            // 处理数值类型
            if (key === 'width' || key === 'height' || key === 'steps' || key === 'batch_size') {
              params[key] = parseInt(value);
            } else if (value) {
              params[key] = value;
            }
          }
          
          // 检查是否为重试模式
          if (isRetryMode) {
            if (!params.taskId) {
              throw new Error('重试任务时需要提供任务 ID');
            }
            
            // 添加状态更新
            addStatusItem(`开始重试任务 ${params.taskId}`, 'retry_start');
            
            // 发送重试请求
            const result = await client.retryImage(params);
            
            // 添加状态更新
            addStatusItem(`任务 ${result.taskId} 重试已开始: ${result.message}`, 'retry_initiated');
          } else {
            // 添加状态更新
            addStatusItem('开始生成图像', 'generation_start');
            
            // 发送生成请求
            const result = await client.generateImage(params);
            
            // 添加状态更新
            addStatusItem(`任务 ${result.taskId} 已创建: ${result.message || result.status}`, 'task_created');
            
            // 如果任务立即完成
            if (result.status === 'succeeded' && result.urls && result.urls.length > 0) {
              // 显示结果
              showResults(result.urls, result.taskId);
            }
          }
        } catch (error) {
          // 添加状态更新
          addStatusItem(`错误: ${error.message}`, 'error');
          
          // 设置错误状态
          statusPanel.className = 'error';
        } finally {
          // 启用提交按钮
          submitButton.disabled = false;
        }
      });
      
      // 添加状态项目
      function addStatusItem(message, type, data = null) {
        const date = new Date();
        const timestamp = date.toLocaleTimeString();
        
        const statusItem = document.createElement('div');
        statusItem.className = `status-item status-${type}`;
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'timestamp';
        timestampSpan.textContent = timestamp;
        
        statusItem.appendChild(timestampSpan);
        statusItem.appendChild(document.createTextNode(message));
        
        // 如果是任务更新，存储任务ID
        if (data && data.taskId) {
          statusItem.dataset.taskId = data.taskId;
          
          // 高亮新状态
          statusItem.classList.add('highlight');
          setTimeout(() => {
            statusItem.classList.remove('highlight');
          }, 3000);
        }
        
        // 添加到状态面板
        statusContent.appendChild(statusItem);
        
        // 滚动到底部
        statusContent.scrollTop = statusContent.scrollHeight;
      }
      
      // 显示结果
      function showResults(urls, taskId) {
        // 清空现有结果
        imageGrid.innerHTML = '';
        
        // 创建图像元素
        urls.forEach((url, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'image-item';
          
          const img = document.createElement('img');
          img.src = url;
          img.alt = `生成的图像 ${index + 1}`;
          img.title = `任务 ID: ${taskId}`;
          img.loading = 'lazy';
          
          const imageActions = document.createElement('div');
          imageActions.className = 'image-actions';
          
          const downloadButton = document.createElement('button');
          downloadButton.textContent = '下载';
          downloadButton.addEventListener('click', () => {
            downloadImage(url, `image_${taskId}_${index + 1}.png`);
          });
          
          imageActions.appendChild(downloadButton);
          imageItem.appendChild(img);
          imageItem.appendChild(imageActions);
          imageGrid.appendChild(imageItem);
        });
        
        // 显示结果容器
        resultContainer.style.display = 'block';
        
        // 滚动到结果
        resultContainer.scrollIntoView({ behavior: 'smooth' });
      }
      
      // 下载图像
      function downloadImage(url, filename) {
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = filename;
        anchor.style.display = 'none';
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
      }
      
      // 更新任务历史
      function updateTaskHistory(data) {
        // 存储或更新任务数据
        if (!taskHistory.has(data.taskId)) {
          taskHistory.set(data.taskId, {
            ...data,
            firstSeen: new Date().toISOString()
          });
        } else {
          taskHistory.set(data.taskId, {
            ...taskHistory.get(data.taskId),
            ...data,
            lastUpdated: new Date().toISOString()
          });
        }
        
        // 重新渲染任务历史
        renderTaskHistory();
        
        // 如果有现有的任务项，高亮它
        const taskItem = document.querySelector(`.task-item[data-task-id="${data.taskId}"]`);
        if (taskItem) {
          taskItem.classList.add('highlight-animation');
          setTimeout(() => {
            taskItem.classList.remove('highlight-animation');
          }, 2000);
        }
      }
      
      // 渲染任务历史
      function renderTaskHistory() {
        taskHistoryElement.innerHTML = '';
        
        // 按最后更新时间倒序排列
        const sortedTasks = Array.from(taskHistory.values()).sort((a, b) => {
          const timeA = a.lastUpdated || a.firstSeen;
          const timeB = b.lastUpdated || b.firstSeen;
          return new Date(timeB) - new Date(timeA);
        });
        
        if (sortedTasks.length === 0) {
          taskHistoryElement.textContent = '尚无任务历史';
          return;
        }
        
        sortedTasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = 'task-item';
          taskItem.dataset.taskId = task.taskId;
          
          const taskHeader = document.createElement('div');
          taskHeader.className = 'task-header';
          
          const taskId = document.createElement('div');
          taskId.className = 'task-id';
          taskId.textContent = `ID: ${task.taskId}`;
          
          const taskStatus = document.createElement('div');
          taskStatus.className = `task-status status-${task.status || 'unknown'}`;
          taskStatus.textContent = task.status || '未知';
          
          taskHeader.appendChild(taskId);
          taskHeader.appendChild(taskStatus);
          taskItem.appendChild(taskHeader);
          
          if (task.prompt) {
            const taskPrompt = document.createElement('div');
            taskPrompt.className = 'task-prompt';
            taskPrompt.textContent = `提示词: ${task.prompt}`;
            taskItem.appendChild(taskPrompt);
          }
          
          const taskActions = document.createElement('div');
          taskActions.className = 'task-actions';
          
          const viewButton = document.createElement('button');
          viewButton.textContent = '查看详情';
          viewButton.addEventListener('click', () => {
            console.log('任务详情:', task);
            alert(`任务 ${task.taskId} 详情已打印到控制台`);
          });
          
          const retryButton = document.createElement('button');
          retryButton.textContent = '重试任务';
          retryButton.addEventListener('click', () => {
            // 切换到重试模式
            isRetryMode = true;
            retrySection.style.display = 'block';
            toggleRetryButton.textContent = '切换到生成模式';
            submitButton.textContent = '重试任务';
            
            // 填充表单
            document.getElementById('taskId').value = task.taskId;
            if (task.prompt) document.getElementById('prompt').value = task.prompt;
            if (task.negative_prompt) document.getElementById('negative_prompt').value = task.negative_prompt;
            if (task.width) document.getElementById('width').value = task.width;
            if (task.height) document.getElementById('height').value = task.height;
            if (task.steps) document.getElementById('steps').value = task.steps;
            if (task.batch_size) document.getElementById('batch_size').value = task.batch_size;
            
            // 滚动到表单
            generateForm.scrollIntoView({ behavior: 'smooth' });
          });
          
          taskActions.appendChild(viewButton);
          
          // 如果任务失败，添加重试按钮
          if (task.status === 'failed') {
            taskActions.appendChild(retryButton);
          }
          
          taskItem.appendChild(taskActions);
          taskHistoryElement.appendChild(taskItem);
        });
      }
      
      // 自动连接 SSE
      setTimeout(() => {
        connectButton.click();
      }, 500);
    });
  </script>
</body>
</html>
