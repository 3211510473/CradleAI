# Cradle 云服务支付功能说明文档

## 概述

本文档详细介绍了 Cradle 云服务的支付功能实现，包括用户支付流程、数据流转过程以及系统配置要求。通过集成 ZPay 支付平台，实现了用户订阅计划的购买和许可证激活功能。

## 一、支付功能简介

Cradle 云服务提供三种订阅计划：

1. **月度计划**：¥15/月
2. **季度计划**：¥50/季度
3. **年度计划**：¥140/年

每个计划提供的核心功能包括：
- 直接访问 Gemini 和 OpenRouter 模型
- 无限图片生成 (年付用户享有优先处理)
- 增强的联网搜索功能
- 基于位置的搜索能力
- 自动获得所有未来功能更新

## 二、用户支付全流程

### 1. 选择订阅计划
用户访问 Cradle 云服务的[价格页面](https://official.cradleintro.com/pricing.html)，浏览不同订阅计划的详细信息和价格对比。

### 2. 点击订阅按钮
用户选择合适的订阅计划后，点击"立即订阅"按钮，系统弹出支付模态窗口。

### 3. 填写支付信息
在支付模态窗口中，用户需要：
   - 确认订阅计划和价格
   - 选择支付方式（支付宝或微信支付）
   - 填写邮箱地址（用于接收许可证和订阅信息）
   - 同意服务条款和退款政策

### 4. 提交订单
用户点击"确认支付"按钮提交订单，系统生成唯一订单号并调用 ZPay 支付接口。

### 5. 完成支付
根据所选支付方式，用户将：
   - 如果是 PC 端：界面显示支付二维码，用户使用手机扫描完成支付
   - 如果是移动端：直接跳转至支付宝或微信支付页面完成支付

### 6. 支付结果处理
支付完成后：
   - 成功支付：用户被重定向到支付成功页面，显示订阅详情和许可证信息
   - 支付失败：用户可以重新发起支付或选择其他支付方式

### 7. 许可证发放
支付成功后，系统自动：
   - 生成对应订阅计划的许可证
   - 通过邮件将许可证发送给用户
   - 在用户账户中激活相应的高级功能

## 三、支付流程数据流

```
┌───────────┐     1.选择计划     ┌───────────┐     2.创建订单     ┌───────────┐
│  用户浏览器 │ ───────────────> │  网站服务器 │ ───────────────> │  ZPay 服务 │
└───────────┘                  └───────────┘                  └───────────┘
      │                              ^                              │
      │                              │                              │
      │                      4.支付回调处理                          │
      │                              │                              │
      │                              │                              │
      │         3.支付请求            │                              │
      └──────────────────────────────┼──────────────────────────────┘
                                     │
                                     ▼
                               ┌───────────┐
                               │ 许可系统   │
                               └───────────┘
```

### 详细数据流程：

1. **选择计划流程**
   - 用户在前端选择订阅计划
   - 前端发送包含计划信息的请求到后端 `/api/create_payment`
   - 请求数据包括：计划名称、金额、订单号、支付方式、用户邮箱

2. **创建订单流程**
   - 后端服务器接收请求并验证数据
   - 生成唯一订单号和签名
   - 发送请求到 ZPay API (`https://zpayz.cn/mapi.php`)
   - ZPay 返回支付链接或二维码信息

3. **支付请求流程**
   - 前端展示支付二维码或跳转支付链接
   - 用户通过手机扫描二维码或在跳转页面完成支付
   - ZPay 处理支付请求并验证支付状态

4. **支付回调处理**
   - ZPay 向网站回调地址发送支付结果通知
   - 许可系统验证支付回调的签名
   - 检查支付状态和订单信息
   - 生成许可证并记录交易
   - 发送许可证邮件给用户
   - 返回处理结果给 ZPay

## 四、需自主配置的信息

### 1. ZPay 支付配置

在 `server.py` 和 `app.py` 中需配置：

```python
# ZPay配置
ZPAY_URL = 'https://zpayz.cn/submit.php'     # ZPay提交接口
ZPAY_API_URL = 'https://zpayz.cn/mapi.php'   # ZPay API接口
ZPAY_PID = '2025032112555648'                # 需替换为您的商户ID
ZPAY_PKEY = '6J3xhFQ2MzVuQI7KuWPiid2ZE5PSjYdq'  # 需替换为您的商户密钥
```

### 2. 回调地址配置

需要在服务器端配置正确的回调地址：

```python
# 服务器配置
NOTIFY_URL = 'https://yourdomain.com/api/license/payment/callback'  # 支付回调URL
RETURN_URL = 'https://yourdomain.com/payment_success.html'          # 支付成功跳转页面
```

### 3. 许可证系统配置

在 `license_system/app.py` 中需配置：

```python
# 计划有效期配置
PLAN_DURATIONS = {
    'monthly': 30,    # 月度计划有效期（天）
    'quarterly': 90,  # 季度计划有效期（天）
    'yearly': 365     # 年度计划有效期（天）
}
```

### 4. 服务器配置参数

在 `license_system/server/app.py` 中需配置：

```python
# 支付回调安全配置
PAYMENT_WEBHOOK_SECRET = '您的回调密钥'  # 用于验证回调签名

# API配置
API_URL_PREFIX = '/api'
API_HOST = '0.0.0.0'
API_PORT = 5001
API_ADMIN_TOKEN = '管理员访问令牌'  # 管理员API的访问令牌
```

### 5. 数据库配置

数据库连接信息需在各处理模块中更新：

```python
# 数据库连接参数
DB_HOST = 'localhost'
DB_USER = 'username'
DB_PASSWORD = 'password'
DB_NAME = 'cradle_license'
```

### 6. 邮件发送配置

在 `license_system/email_service.py` 中需配置：

```python
# 邮件服务器配置
EMAIL_HOST = 'smtp.example.com'
EMAIL_PORT = 587
EMAIL_USER = 'noreply@cradle-ai.com'
EMAIL_PASSWORD = '您的邮箱密码'
EMAIL_FROM = 'Cradle AI <noreply@cradle-ai.com>'
```

## 五、部署注意事项

1. **域名和SSL证书**
   - 确保网站使用 HTTPS 加密，以保障支付数据安全
   - 申请并配置有效的 SSL 证书

2. **防火墙配置**
   - 确保服务器允许 ZPay 的 IP 地址访问回调接口
   - 配置适当的防火墙规则，防止非法请求

3. **数据备份**
   - 定期备份订单和许可证数据库
   - 建立自动备份机制，避免数据丢失

4. **日志记录**
   - 配置详细的支付流程日志
   - 记录所有支付相关操作，包括成功和失败事件
   - 设置日志轮转策略，避免日志文件过大

5. **错误处理和监控**
   - 实现支付异常监控和报警机制
   - 配置系统自动通知管理员支付异常情况

## 六、安全建议

1. **签名验证**
   - 严格验证所有来自 ZPay 的回调签名
   - 拒绝处理无效签名的回调请求

2. **数据加密**
   - 敏感数据（如密钥、密码）应使用环境变量或配置文件存储
   - 避免在代码中硬编码敏感信息

3. **防重放攻击**
   - 实现订单处理的幂等性，确保每个订单只处理一次
   - 使用交易ID作为唯一标识符，防止重复处理

4. **定期更新**
   - 定期更新服务器和依赖库，修复潜在安全漏洞
   - 关注 ZPay 的安全公告和接口更新

## 七、故障排除指南

1. **支付失败**
   - 检查 ZPay 商户信息是否正确
   - 验证签名生成算法是否符合 ZPay 要求
   - 查看服务器日志中的详细错误信息

2. **回调未触发**
   - 确认回调 URL 配置正确且公网可访问
   - 检查服务器防火墙是否阻止了来自 ZPay 的请求
   - 联系 ZPay 客服确认回调请求是否已发出

3. **许可证未生成**
   - 检查数据库连接和配置
   - 验证许可证生成逻辑是否包含错误
   - 确认支付回调处理函数执行完整

4. **邮件未发送**
   - 检查邮件服务器配置和凭据
   - 验证邮件模板和发送逻辑
   - 检查用户提供的邮箱地址是否有效