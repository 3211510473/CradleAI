## ZPay 支付API 文档

**接口地址:** `https://zpayz.cn/`

**商户ID (PID):** `2025032112555648`

**商户密钥 (PKEY):** `6J3xhFQ2MzVuQI7KuWPiid2ZE5PSjYdq`

**注意:** 本API兼容易支付接口。

### 1. 页面跳转支付 (Submit)

**说明:**  用户前台直接发起支付，使用表单跳转或拼接URL跳转。

**请求URL:** `https://zpayz.cn/submit.php`

**请求方法:** `POST` (推荐) 或 `GET`

**请求参数:**

| 参数名        | 类型    | 必填 | 描述                               | 示例                             |
| ------------- | ------- | ---- | ---------------------------------- | -------------------------------- |
| `name`        | String  | 是   | 商品名称 (不超过100字)            | `iphonexs max`                     |
| `money`       | String  | 是   | 订单金额 (最多保留两位小数)         | `5.67`                           |
| `type`        | String  | 是   | 支付方式 (`alipay`:支付宝, `wxpay`:微信) | `alipay`                         |
| `out_trade_no`| Num     | 是   | 订单编号 (每个商品不可重复)         | `201911914837526544601`          |
| `notify_url`  | String  | 是   | 异步通知页面 (不支持带参数)        | `http://www.aaa.com/bbb.php`     |
| `pid`         | String  | 是   | 商户唯一标识                           | `201901151314084206659771`        |
| `cid`         | String  | 否   | 支付渠道ID (不填则随机使用)          | `1234`                           |
| `param`       | String  | 否   | 附加内容 (原样返回到 `notify_url`) | `金色 256G`                       |
| `return_url`  | String  | 是   | 跳转页面 (交易完成后跳转, 不支持带参数) | `http://www.aaa.com/ccc.php`     |
| `sign`        | String  | 是   | 签名 (参考签名算法)                  | `28f9583617d9caf66834292b6ab1cc89` |
| `sign_type`   | String  | 是   | 签名方法 (默认为 `MD5`)            | `MD5`                            |

**用法举例:**

```
https://zpayz.cn/submit.php?name=iphone xs Max 一台&money=0.03&out_trade_no=201911914837526544601&notify_url=http://www.aaa.com/notify_url.php&pid=201901151314084206659771&param=金色 256G&return_url=http://www.baidu.com&sign=28f9583617d9caf66834292b6ab1cc89&sign_type=MD5&type=alipay
```

**成功返回:** 直接跳转到付款页面 (收银台)。

**失败返回:** `{"code":"error","msg":"具体的错误信息"}`

### 2. API 接口支付 (MAPI)

**说明:** 通过 API 接口发起支付。

**请求URL:** `https://zpayz.cn/mapi.php`

**请求方法:** `POST` (方式为 `form-data`)

**请求参数:**

| 字段名        | 变量名        | 类型    | 必填 | 示例值                         | 描述                                                               |
| ------------- | ------------- | ------- | ---- | ------------------------------ | ------------------------------------------------------------------ |
| 商户ID        | `pid`         | String  | 是   | `1001`                         |                                                                    |
| 支付渠道ID    | `cid`         | String  | 否   | `1234`                         | 不填则随机使用某一支付渠道                                                     |
| 支付方式        | `type`        | String  | 是   | `alipay`                         | `alipay`:支付宝, `wxpay`:微信                                                    |
| 商户订单号    | `out_trade_no`| String  | 是   | `20160806151343349`            |                                                                    |
| 异步通知地址  | `notify_url`  | String  | 是   | `http://www.pay.com/notify_url.php` | 服务器异步通知地址                                                            |
| 商品名称        | `name`        | String  | 是   | `VIP会员`                        | 如超过127个字节会自动截取                                                             |
| 商品金额        | `money`       | String  | 是   | `1.00`                         | 单位：元，最大2位小数                                                               |
| 用户IP地址     | `clientip`    | String  | 是   | `192.168.1.100`                | 用户发起支付的IP地址                                                              |
| 设备类型        | `device`      | String  | 否   | `pc`                           | 根据当前用户浏览器的UA判断，传入用户所使用的浏览器或设备类型，默认为pc                                               |
| 业务扩展参数  | `param`       | String  | 否   |  (空)                          | 支付后原样返回                                                                 |
| 签名字符串      | `sign`        | String  | 是   | `202cb962ac59075b964b07152d234b70` | 签名算法参考本页底部                                                            |
| 签名类型        | `sign_type`   | String  | 是   | `MD5`                          | 默认为MD5                                                                 |

**成功返回:**

| 字段名       | 变量名     | 类型   | 示例值                               | 描述                               |
| ----------- | ---------- | ------ | ----------------------------------- | ---------------------------------- |
| 返回状态码   | `code`     | Int    | `1`                                 | `1`为成功，其它值为失败                    |
| 返回信息     | `msg`      | String |                                      | 失败时返回原因                             |
| 订单号       | `trade_no` | String | `20160806151343349`                | 支付订单号                               |
| ZPAY内部订单号 | `O_id`     | String | `123456`                            | ZPAY内部订单号                             |
| 支付跳转url  | `payurl`   | String | `https://xxx.cn/pay/wxpay/202010903/` | 如果返回该字段，则直接跳转到该url支付             |
| 二维码链接   | `qrcode`   | String | `https://xxx.cn/pay/wxpay/202010903/` | 如果返回该字段，则根据该url生成二维码            |
| 二维码图片   | `img`      | String | `https://z-pay.cn/qrcode/123.jpg`   | 该字段为付款二维码的图片地址                     |

**失败返回:** `{"code":"error","msg":"具体的错误信息"}`

### 3. 微信小程序支付

**步骤:**

1.  **使用“API接口支付”获取到 `O_id` 参数。**
2.  **跳转 ZPAY 收银台小程序:**

    *   小程序 `appid`: `wxa9882fcbc23a0181`
    *   跳转代码 (示例):

    ```javascript
    wx.navigateToMiniProgram({
        appId: 'wxa9882fcbc23a0181',
        path: 'pages/pay/pay?type=wxapp&O_id=123456', //请将123456替换为第一步获取到的O_id
        fail(res) {
            wx.showToast({
                title: res.errMsg,
                icon: 'none',
            });
        },
        success(res) {
            wx.showToast({
                title: 'ok',
                icon: 'none',
            });
        },
    });
    ```
3.  **支付结果:**

    *   支付成功: `extraData: { status: 'success' }`
    *   支付取消: `extraData: { status: 'cancel' }`

### 4. 查询单个订单

**请求URL:** `https://zpayz.cn/api.php?act=order&pid={商户ID}&key={商户密钥}&out_trade_no={商户订单号}`

**请求方法:** `GET`

**请求参数:**

| 参数名        | 类型    | 必填 | 描述                              | 示例                     |
| ------------- | ------- | ---- | --------------------------------- | ------------------------ |
| `act`         | String  | 是   | 固定值 `order`                    | `order`                  |
| `pid`         | String  | 是   | 商户ID                           | `20220715225121`         |
| `key`         | String  | 是   | 商户密钥                           | `89unJUB8HZ54Hj7x4nUj56HN4nUzUJ8i` |
| `trade_no`    | String  | 选择 | 系统订单号                         | `20160806151343312`      |
| `out_trade_no`| String  | 选择 | 商户订单号                         | `20160806151343349`      |

**返回结果:**

| 字段名        | 变量名     | 类型   | 示例值                  | 描述                                           |
| ------------- | ---------- | ------ | ----------------------- | ---------------------------------------------- |
| 返回状态码    | `code`     | Int    | `1`                     | `1`为成功，其它值为失败                        |
| 返回信息      | `msg`      | String | `查询订单号成功！`        |                                                |
| 易支付订单号  | `trade_no` | String | `2016080622555342651`   | 易支付订单号                                     |
| 商户订单号    | `out_trade_no`| String | `20160806151343349`   | 商户系统内部的订单号                               |
| 支付方式      | `type`     | String | `alipay`                | `alipay`:支付宝, `wxpay`:微信                       |
| 商户ID        | `pid`      | String | `20220715225121`        | 发起支付的商户ID                                   |
| 创建订单时间  | `addtime`  | String | `2016-08-06 22:55:52`   |                                                |
| 完成交易时间  | `endtime`  | String | `2016-08-06 22:55:52`   |                                                |
| 商品名称      | `name`     | String | `VIP会员`               |                                                |
| 商品金额      | `money`    | String | `1.00`                  |                                                |
| 支付状态      | `status`   | Int    | `0`                     | `1`为支付成功，`0`为未支付                          |
| 业务扩展参数  | `param`    | String |                         | 默认留空                                         |
| 支付者账号    | `buyer`    | String |                         | 默认留空                                         |

### 5. 提交订单退款

**请求URL:** `https://zpayz.cn/api.php?act=refund`

**请求方法:** `POST`

**请求参数:**

| 字段名         | 变量名         | 类型    | 必填 | 示例值                         | 描述                                                           |
| -------------- | -------------- | ------- | ---- | ------------------------------ | -------------------------------------------------------------- |
| 商户ID         | `pid`          | String  | 是   | `20220715225121`             |                                                                |
| 商户密钥       | `key`          | String  | 是   | `89unJUB8HZ54Hj7x4nUj56HN4nUzUJ8i` |                                                                |
| 易支付订单号   | `trade_no`     | String  | 特殊可选 | `20160806151343349021`         | 易支付订单号                                                     |
| 商户订单号     | `out_trade_no` | String  | 特殊可选 | `20160806151343349`            | 订单支付时传入的商户订单号，商家自定义且保证商家系统中唯一                                            |
| 退款金额       | `money`        | String  | 是   | `1.50`                         | 大多数通道需要与原订单金额一致                                                      |

**注意：**`trade_no` 和 `out_trade_no` 两个参数 **必须选择一个** 传入。

**返回结果:**

| 字段名      | 变量名   | 类型   | 示例值   | 描述                                         |
| ----------- | -------- | ------ | -------- | -------------------------------------------- |
| 返回状态码  | `code`   | Int    | `1`      | `1`为成功，其它值为失败                        |
| 返回信息    | `msg`    | String | `退款成功` |                                              |

### 6. 支付结果通知

**请求URL:** 服务器异步通知 (`notify_url`)、页面跳转通知 (`return_url`)

**请求方法:** `GET`

**请求参数:**

| 参数名         | 类型    | 描述                                | 示例                      |
| ------------- | ------- | ----------------------------------- | ------------------------- |
| `pid`         | Int     | 商户ID                               | `201901151314084206659771`|
| `name`        | String  | 商品名称 (不超过100字)             | `iphone`                    |
| `money`       | String  | 订单金额 (最多保留两位小数)          | `5.67`                    |
| `out_trade_no`| Num     | 商户订单号                             | `201901191324552185692680`|
| `trade_no`    | String  | 易支付订单号                            | `2019011922001418111011411195`|
| `param`       | String  | 业务扩展参数 (原样返回)             | `金色 256G`                 |
| `trade_status`| String  | 支付状态 (`TRADE_SUCCESS` 是成功) | `TRADE_SUCCESS`           |
| `type`        | String  | 支付方式 (`alipay` / `wxpay`)     | `alipay`                  |
| `sign`        | String  | 签名 (参考签名算法)                    | `ef6e3c5c6ff45018e8c82fd66fb056dc`|
| `sign_type`   | String  | 签名类型 (默认为 `MD5`)              | `MD5`                     |

**如何验证:**

1.  根据签名算法，验证自己生成的签名与参数中传入的签名是否一致。
2.  如果一致，则说明是由官方向您发送的真实信息。

**注意事项:**

1.  收到回调信息后请返回 `"success"`，否则程序将判定您的回调地址未正确通知到。
2.  同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。
3.  推荐的做法是，当收到通知进行处理时，首先检查对应业务数据的状态，判断该通知是否已经处理过，如果没有处理过再进行处理，如果处理过直接返回结果成功。在对业务数据进行状态检查和处理之前，要采用数据锁进行并发控制，以避免函数重入造成的数据混乱。
4.  特别提醒：商户系统对于支付结果通知的内容一定要做签名验证,并校验返回的订单金额是否与商户侧的订单金额一致，防止数据泄漏导致出现“假通知”，造成资金损失。
5.  对后台通知交互时，如果平台收到商户的应答不是纯字符串success或超过5秒后返回时，平台认为通知失败，平台会通过一定的策略（通知频率为0/15/15/30/180/1800/1800/1800/1800/3600，单位：秒）间接性重新发起通知，尽可能提高通知的成功率，但不保证通知最终能成功。

### 7. MD5 签名算法

1.  将发送或接收到的所有参数按照参数名ASCII码从小到大排序 (a-z)，`sign`、`sign_type` 和空值不参与签名!
2.  将排序后的参数拼接成URL键值对的格式，例如 `a=b&c=d&e=f`，参数值不要进行url编码。
3.  再将拼接好的字符串与商户密钥KEY进行MD5加密得出sign签名参数，`sign = md5 ( a=b&c=d&e=f + KEY )` (注意：`+` 为各语言的拼接符，不是字符！)，md5结果为小写。
4.  具体签名与发起支付的示例代码可下载SDK查看。

**重要提示:** 请务必仔细阅读并理解签名算法，确保您的签名正确，以保障接口安全。