## 角色生成器需求整理

**目标：** 构建一个角色生成器，利用初始数据和用户投喂数据，通过 Gemini LLM 生成并迭代角色设定信息。

**1. 前端更新：**

*   **投喂类型选择：** 用户投喂数据时，需允许选择以下类型之一：
    *   "关于我"：个人信息和偏好。
    *   "素材"：角色设定的参考信息。
    *   "知识"：角色需要记住的内容。
*   **消息队列：** 用户投喂的信息应暂存到消息盒子，并定期批量发送给后端，而非每次投喂都进行处理。

**2. 后端构建：角色生成器**

*   **核心功能：** 接收摇篮系统传入的初始数据和用户投喂数据，利用 Gemini LLM 生成和迭代角色设定信息。
*   **LLM 交互：**
    *   使用 Gemini 作为 LLM。
    *   通过 `gemini-adapter.ts` 发送请求。
    *   通过 `prompt-builder-service.ts` 构建请求体，包含 R 框架和 D 类条目，以提供任务提示词和角色投喂内容。
*   **Prompt 结构 (待优化):**
    *   **初始角色设定：**
        ```
        [R框架1] 要求模型理解角色生成器的任务和规则。
        [R框架2] "以下为初始的角色信息："+ 输入的初始信息
        ```
    *   **更新角色设定：**
        ```
        [R框架1] 要求模型理解角色生成器的任务和规则。
        [R框架2] "以下为输入的用户信息："+ 输入的"关于我"的投喂内容
        [R框架3] "以下为上一次的角色设定："+ 上一次生成的角色设定内容
        [R框架4] "以下为输入的知识信息："+ 输入的"知识"内容
        [R框架5] "以下为输入的素材信息："+ 输入的"素材"内容
        ```
*   **多次请求处理：**
    *   角色生成器将多次发送请求给 Gemini，以处理用户的多次投喂。
    *   **上下文管理：** 不应在 `chathistory` 中留存对话历史。 上一次生成的角色设定数据应包含在 R 框架中。
*   **提示词设计要点：**
    *   **数据理解与利用：** Gemini 需正确理解和利用初始数据和投喂数据来生成/更新角色设定。
    *   **格式规范：** Gemini 的回复必须为规范的 JSON 格式，以便提取键值对。
    *   **类型匹配：** Gemini 回复的 JSON 内容必须与 `nodest/types/types` 文件中的 `RoleCardJson` 和 `WorldBookJson` 类型完全匹配，以保证 App 的正常功能。
        *   `RoleCardJson`：
            *   生成 `first_mes` 和 `description` 字段的内容。
            *   `name` 字段留空 (前端定义)。
        *   `WorldBookJson`：
            *   生成 `WorldBookEntry` 条目内容（D 类条目）。
            *   生成内容中，固定包含以下两类条目的内容：
                *   `Alist`：角色设定的详细信息，结构化形式 (XML/HTML)，`depth=1`，`position=4`。
                *   `Plist`：角色的对话示例，`depth=1`，`position=4`。
        *   `WorldBookJson` 生成规则：
            *   "关于我"：生成记载用户信息的 D 类条目。
            *   "知识"：生成知识型 D 类条目。
            *   "素材"：影响 `Alist` 和 `Plist` 的内容。
        *   **条目类型与深度：** Gemini 需理解插入类型和插入深度对角色上下文记忆的影响。
*   **回复清洗：** 角色生成器应对 Gemini 的回复进行正则清洗，仅提取 JSON 内容。
*   **数据映射：** 角色生成器应根据清洗后的内容，生成完全匹配 `nodest/types/types` 中 `RoleCardJson` 和 `WorldBookJson` 类型的数据。
*   **图片数据：** 暂时忽略图片数据的发送（需要 `gemini-adapter` 适配）。

**3. 补充说明：**

*   **错误处理：** 添加错误处理机制，例如当 Gemini 无法生成符合格式的内容时，应给出友好的提示，并尝试重新生成。
*   **性能优化：** 考虑 Gemini 的 API 调用频率限制，优化请求发送策略。
*   **日志:** 详细可追溯的中文日志，记录请求和回复，方便调试和问题排查。

