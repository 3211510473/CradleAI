# Brave Search 功能文档

## 功能概述

Brave Search 功能允许 AI 助手在对话中进行互联网搜索，获取最新信息后回复用户问题，大大增强了助手的知识广度与时效性。当用户询问关于实时信息（如天气、新闻、体育赛事等）的问题时，AI 可以通过 Brave Search API 获取最新数据并融入回复中。

## 技术实现

该功能通过以下组件实现：

1. **MCP 适配器**：集成 Model Context Protocol，连接 Brave Search API
2. **工具调用接口**：让 AI 模型能够在对话流程中调用外部工具
3. **UI 控制开关**：允许用户手动开启/关闭搜索功能
4. **参数传递链**：从 UI 组件到底层 API 传递搜索功能状态

## 使用方法

1. 在聊天界面顶部找到「搜索: 开/关」切换按钮
2. 开启后，AI 会自动识别需要最新信息的问题，并触发搜索
3. 搜索结果会无缝融入 AI 的回复中，并附带信息来源引用
4. 随时可以关闭搜索功能，AI 将仅使用自身知识库回答问题

## 技术流程

1. **用户界面层**：
   - 在 `index.tsx` 中添加了搜索开关按钮
   - 用户偏好存储在 AsyncStorage 中持久化
   - 通过 `NodeSTManager.setSearchEnabled()` 传递搜索状态

2. **管理层**：
   - `NodeSTManager` 维护搜索功能状态
   - 将 `useToolCalls` 参数传递给底层 `NodeST` 实例

3. **核心处理层**：
   - `NodeST` 将搜索参数传递给 `NodeSTCore`
   - `NodeSTCore.continueChat()` 根据 `useToolCalls` 参数决定处理模式
   - 启用搜索时调用 `processChatWithTools()`，否则调用标准 `processChat()`

4. **API 适配层**：
   - 模型的调用输出包含搜索意图识别
   - `GeminiAdapter` 或 `OpenRouterAdapter` 进行工具调用处理
   - 通过 `mcpAdapter` 访问 Brave Search API

## 技术注意事项

1. **搜索阈值**：
   - 模型会自行判断问题是否需要搜索
   - 搜索仅在问题可能需要最新信息时触发，避免不必要的 API 调用

2. **搜索结果处理**：
   - 结果由模型进行筛选和总结，而非直接显示全部
   - 搜索结果以 Markdown 格式提供，包含来源引用

3. **API 限制**：
   - Brave Search API 有调用频率限制
   - 应注意避免过度调用导致服务中断

4. **调试信息**：
   - 搜索调用过程有完整日志记录
   - 日志显示搜索是否触发、查询内容、结果数量等

## 搜索能力示例

搜索功能特别适合以下类型的问题：

- 最新新闻事件：「今天有什么重要新闻？」
- 实时数据查询：「现在上海的天气怎么样？」
- 事实验证：「2023年中国GDP是多少？」
- 知识扩展：「量子计算最新进展是什么？」
- 专业领域更新：「最新的AI论文有哪些突破？」

## 隐私考虑

- 搜索查询会发送到 Brave Search 服务器
- 默认使用温和的安全搜索设置
- 搜索历史不会在会话结束后保留

## 未来优化方向

1. 允许用户指定搜索源或地区偏好
2. 增加对图片和视频搜索结果的支持
3. 提供搜索历史查看功能
4. 改进搜索结果的引用和格式化展示
5. 添加多种搜索引擎支持

## 故障排除

如果搜索功能不正常，请检查：

1. Brave API 密钥是否有效
2. 网络连接是否正常
3. 应用日志中是否有详细错误信息
4. 重启应用后再次尝试
5. 确认搜索开关已正确开启
