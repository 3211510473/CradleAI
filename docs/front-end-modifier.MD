**项目目标：** 在聊天对话窗口Chatdialog中，为 AI 发送的消息条构建一个稳定、高性能且 React Native 友好的渲染引擎，能够处理特定格式的 HTML 内容，并实现近似的视觉效果，同时为未来的扩展和维护做好准备。

**用户故事：**

*   作为用户，我希望看到 AI 发送的消息条能够以美观、易读且具有一定视觉效果的方式呈现。
*   作为开发者，我希望能够轻松地处理 AI 发送的特定格式的 HTML 内容，并将其渲染为 React Native 组件。
*   作为开发者，我希望渲染引擎具有良好的性能，即使在处理大量消息时也能保持流畅。
*   作为开发者，我希望渲染引擎具有良好的可维护性和可扩展性，方便添加新的功能和支持新的 HTML 标签。

**功能需求：**

1.  **HTML 渲染引擎：**

    *   **支持的 HTML 标签（精简版）：**
        *   结构标签：`<div>`, `<p>`, `<br>`
        *   文本格式：`<b>`, `<i>`, `<span>`
        *   列表：`<ul>`, `<ol>`, `<li>`
        *   图片：`<img>` (支持本地图片和网络图片，网络图片需进行安全验证)
        *   链接：`<a>`
        *   可折叠面板：`<details>`, `<summary>` (使用 React Native 组件模拟)
    *   **不支持的 HTML 标签：**
        *   `<head>`, `<style>`, `<script>`, `<audio>`, `<svg>`, 以及其他未明确列出的标签。
    *   **支持的 CSS 属性（精简版）：**
        *   文本：`color`, `font-size`, `font-weight`, `font-style`, `font-family`, `text-align`, `line-height`, `text-shadow`, `letter-spacing`
        *   盒模型：`margin`, `padding`, `border`, `border-radius`, `width`, `height`
        *   背景：`background-color`, `background-image` (支持本地图片和网络图片，渐变色使用 `<LinearGradient>`)
        *   定位：`position`, `top`, `left`, `right`, `bottom`
        *   其他：`opacity`, `overflow`, `box-shadow` (简化实现), `display` (仅支持 `flex` 相关属性), `flex-direction`, `justify-content`, `align-items`, `gap`
    *   **不支持的 CSS 属性：**
        *   `@import`, 伪元素, 复杂的选择器, `filter` (除 `opacity` 外), `animation`, `@keyframes`
    *   **安全：**
        *   对所有 HTML 内容进行严格的安全检查和过滤，防止 XSS 攻击。
        *   限制网络图片和链接的来源。
        *   禁止内联 JavaScript。
    *   **性能：**
        *   使用虚拟化列表（例如 `FlatList`）来渲染大量的消息条。
        *   缓存解析后的 HTML 结构和样式。
        *   避免不必要的组件渲染和重绘。
    *   **错误处理：**
        *   优雅地处理 HTML 解析错误和渲染错误。
        *   提供错误日志，方便调试。

2.  **自定义渲染器框架：**

    *   **模块化设计：** 将渲染器划分为不同的组件，例如文本渲染器、图片渲染器、列表渲染器等。
    *   **可扩展性：** 方便添加新的渲染器组件，支持更多 HTML 标签和 CSS 样式。
    *   **可配置性：** 允许配置渲染器组件的行为，例如设置默认字体、颜色等。
    *   **可替换性：** 允许替换现有的渲染器组件，实现自定义的渲染逻辑 (提供有限的接口)。

3.  **数据结构：**

    *   **规范化 HTML:**  使用一个中间格式的 JSON，包含解析过和验证过的 HTML 内容和属性。 不要直接接收原始的 HTML 字符串。
        ```json
        [
          {
            type: "tag",
            name: "div",
            attributes: { style: "color: red;" },
            children: [
              { type: "text", content: "Hello" },
              { type: "tag", name: "b", children: [{ type: "text", content: "World" }] }
            ]
          }
        ]
        ```
    *   **支持元数据：** 为消息条提供元数据，例如消息的发送时间、发送者身份、消息 ID 等。

4.  **渲染器更新与维护：**

    *   **版本控制：** 对渲染器组件进行版本控制。
    *   **测试：** 提供单元测试和集成测试，确保渲染器的正确性和稳定性。

5.  **(可选)用户自定义选项 (非常有限):**
    * 允许用户选择一些预定义的风格, 例如主题色。 不要允许用户自定义 HTML 或 CSS。

**技术约束：**

*   **React Native：** 使用 React Native 进行开发。
*   **Expo：** 兼容 Expo 环境。
*   **HTML 解析库：** `react-native-html-parser` (或类似的库)。
*   **渐变色：** `expo-linear-gradient`.
*   **字体：** `@expo-google-fonts/...`
*   **图像处理（可选）:** 如果需要更高级的图像处理 (例如， 模糊), 可以探索 `expo-image-manipulator` 或原生模块.

**非功能需求：**

*   **性能：** 渲染过程高效，不影响聊天窗口的滚动流畅性。目标是 60fps。
*   **安全性：** 严格防止 XSS 攻击和其他安全漏洞。
*   **可维护性：** 代码清晰、模块化、易于理解和修改。
*   **可测试性：** 代码易于测试。
*   **用户体验：** 渲染后的消息美观、易读。
*   **稳定性:**  在各种设备和网络条件下稳定运行。

**验收标准：**

*   AI 发送的消息能够按照预定义的 HTML 和 CSS 规则正确渲染。
*   渲染引擎能够处理大量的消息，并且保持流畅的性能。
*   应用程序对各种安全漏洞具有抵抗力。
*   代码易于理解和维护。

**后续扩展方向：**

*   支持更多的 HTML 标签和 CSS 属性（根据实际需求逐步添加）。
*   优化性能，例如使用更高效的缓存策略。

**重要考虑：**

*   **安全：**  对 HTML 内容进行严格的安全检查和过滤。 这是最重要的。
*   **性能：**  虚拟化列表、缓存、避免不必要的渲染是关键。
*   **简化：**  不要试图支持所有 HTML 和 CSS 特性，只支持需要的特性。
*   **中间格式:** 使用 JSON 作为中间格式， 而不是直接处理原始 HTML 字符串。

**注意事项：**

*   **兼容正常文本：** 如果消息条中没有HTML/CSS，则以原来的消息条呈现方式来呈现。