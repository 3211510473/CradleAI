好的，这是一份基于 OpenRouter 文档，并结合你的 AI 聊天 App 现有功能和需求的详细需求文档：

**项目名称：** 为nodest集成 OpenRouter API

**1. 项目目标：**

1.  将 OpenRouter 集成到现有的 AI 聊天 App 中，作为 Gemini 官方渠道之外的**可选** API 渠道。
2.  为用户提供灵活的模型选择和路由配置，提升用户体验，并降低潜在成本。
3.  确保用户数据安全和隐私，并遵守 OpenRouter 和 Google Play 商店的相关政策。

**2. 背景：**

目前 AI 聊天，通过Chatinput.tsx组件向nodest发送消息，并获取回复。而现在nodest仅支持 Gemini 官方渠道作为 API 来源（使用gemini-adapter.ts）。集成 OpenRouter 将带来以下优势：

*   **更多模型选择：** OpenRouter 提供了数百个 AI 模型，用户可以根据自己的需求和偏好选择不同的模型。
*   **更高的可靠性：** 通过 OpenRouter 的自动路由和备用模型机制，可以提高 API 调用的可靠性，避免因模型故障而导致请求失败。
*   **潜在的成本降低：** 用户可以比较不同模型的价格，选择最经济实惠的方案。
*   **灵活性：** 可以轻松地切换不同的模型，而无需修改大量的代码。
*   **支持更多特性** OpenRouter通过provider路由支持更多特性，例如对数据合规性的支持。

**3. 功能需求：**

**3.1. OpenRouter 设置 (Global Setting)：**
1.将Global-setting 设置中api相关设置移动到Profile页面，今后统一在Profile页面进行api相关设置。

2.当前的gemini api key储存在“角色应用apikey”中，改变这个不正确的名称，并为在profile页面为Gemini渠道的设置安排正确的位置 

3.在Profile页面添加 OpenRouter 选项，提供以下功能：

*   **3.1.1. OpenRouter 开关:** 添加OpenRouter作为 API 渠道。
*   **3.1.2. API Key 输入框:**
    *   允许用户输入 OpenRouter API Key。
    *   提供 "显示/隐藏" 选项，方便用户查看和编辑 API Key。
    *   对 API Key 进行加密存储，确保安全性。
*   **3.1.3. 连接测试按钮:** 添加一个 "测试连接" 按钮。
    *   点击后，向 OpenRouter API 发送一个简单的测试请求 (例如，询问 "你好")。
*   **3.1.4 模型信息获取与展示:**

    *   **3.1.4.1 模型供应商选择器:** (同前)
    *   **3.1.4.2 获取模型列表:**
        *   在用户选择了一个或多个模型供应商后，调用 OpenRouter 的 `List available models` API ( `https://openrouter.ai/api/v1/models` )，获取该供应商支持的模型列表。
        *   缓存模型列表，避免重复调用 API。 缓存失效时间可配置，例如 1 小时。
    *   **3.1.4.3 模型选择器:** (修改)
        *   仅在用户选择了模型供应商后才展示。
        *   提供一个模型选择列表，展示所选供应商下支持的所有模型。
        *   **展示模型信息:** 在模型列表中显示以下模型信息：
            *   模型名称 (name)
            *   模型描述 (description)
            *   Prompt 价格 (pricing.prompt)
            *   Completion 价格 (pricing.completion)
        *   支持按模型名称搜索，方便快速找到需要的模型。
        *   **模型信息排序:** 允许用户按价格、描述、名称排序。
        *   列表中展示模型简要信息，例如价格、速度、擅长领域等。 (如果可以从OpenRouter API 获取到这些信息)


*   **3.1.5. 模型选择器：**
    * 仅在用户选择了模型供应商后才展示。
    * 提供一个模型选择列表，展示所选供应商下支持的所有模型。
    * 支持搜索，方便快速找到需要的模型。
    * 列表中展示模型简要信息，例如价格、速度、擅长领域等。 (如果可以从OpenRouter API 获取到这些信息)
*   **3.1.6. 自动路由开关:**
    *   添加一个开关，用于启用或禁用 OpenRouter 的自动路由功能。
    *   默认状态为 "禁用"。
    *   提供解释文本，说明自动路由的功能和原理 (例如，"根据您的提示，自动选择最合适的模型" )。
*   **3.1.7. 自动切换备用模型开关:**
    *   添加一个开关，用于启用或禁用自动切换备用模型功能。
    *   默认状态为 "启用"。
    *   提供解释文本，说明自动切换备用模型的功能和原理 (例如，"当主模型不可用时，自动切换到其他备用模型，提高可靠性" )。
*   **3.1.8. 备用模型列表设置:**
    * 当“自动切换备用模型开关”开启时可用。
    * 提供添加、删除和排序备用模型的界面。
    * 如果"自动路由"开启，则隐藏此选项，或禁用。
*   **3.1.9. 排序策略选择 (Provider Sorting):**
    *   添加一个下拉菜单，允许用户选择提供商的排序策略。
    *   选项包括："价格优先"、"速度优先"、"延迟优先"。
    *   提供解释文本，说明每种排序策略的含义。
*  **3.1.10 数据合规性**
    * 提供选项让用户选择是否使用允许收集数据的供应商
    * 提供选项让用户选择是否忽略某些特定供应商
    * 提供选项让用户选择量化级别
*  **3.1.11 高级选项:**
    *  将 "排序策略选择"，"数据合规性"， "忽略供应商"， "量化级别" 等配置收纳到高级选项中，默认折叠。 避免界面过于复杂。
*   **3.1.12. 保存按钮:** 点击后保存所有 OpenRouter 设置。

**3.2. API 请求处理：**

*   当 OpenRouter 开关启用时，将 API 请求发送到 OpenRouter API (`https://openrouter.ai/api/v1/chat/completions`)，并使用用户提供的 API Key 进行身份验证。
*   根据用户选择的模型、自动路由状态、备用模型列表和排序策略，构建正确的请求体和头部。
*   处理 OpenRouter API 返回的响应，提取生成的文本，并将其显示在聊天界面上。
*   如果 API 请求失败，显示错误信息，并提供重试选项。

**4. 用户界面 (UI) 需求：**

*   OpenRouter 设置界面应简洁明了，易于使用。
*   提供足够的解释文本，帮助用户理解每个选项的含义。
*   使用清晰的图标和颜色，区分不同的状态 (例如，连接成功/失败，启用/禁用)。
*   对于敏感信息 (例如 API Key)，使用安全的输入控件，并提供显示/隐藏选项。
*   模型选择器列表添加用于展示`description`的区域，模型名称后面显示价格信息。
*   在模型选择器列表顶部提供排序选项。

**5. 技术需求：**
*   **API 调用：**
    *   添加调用 OpenRouter `List available models` API 的功能。
    *   使用异步操作获取模型信息，避免阻塞主线程。
    *   做好错误处理，如果`List available models` API 调用失败，在用户界面显示错误提示，并提供重试选项。
*   **缓存：**
    *   实现模型列表缓存功能，减少 API 调用次数。
    *   缓存失效时间可配置。
*   **编程语言：** 与现有 App 保持一致。
*   **API 客户端：** 使用可靠的 HTTP 客户端库 (例如 `fetch`、`axios`)。
*   **密钥存储：** 使用安全的密钥存储方案，例如操作系统提供的密钥链服务。
*   **错误处理：** 完善的错误处理机制，能够捕获和显示 API 调用过程中出现的各种错误。
*   **日志记录：** 记录关键事件，例如 API 调用成功/失败、用户设置更改等。
*   **OpenRouter SDK (可选):** 如果OpenRouter提供官方SDK，可以考虑采用


**6. 性能需求：**

*   API 调用应尽可能快，避免影响用户体验。
*   对 API Key 进行缓存，避免重复读取密钥存储。
*   使用异步操作，避免阻塞主线程。

**7. 安全需求：**

*   对 OpenRouter API Key 进行加密存储，防止泄露。
*   遵守 OpenRouter 的服务条款和 Google Play 商店的开发者政策。
*   定期审查代码，修复安全漏洞。
*   对用户输入进行验证，防止恶意代码注入。
*   如果OpenRouter提供IP限制等安全选项，考虑添加

**8. 数据和隐私需求：**

*   在隐私政策中明确说明你的应用收集了 OpenRouter 的 API Key，并说明你如何使用和保护这个 API Key。
*   遵守 OpenRouter 的数据使用政策。
*   提供选项，让用户可以控制是否使用允许数据收集的供应商 (参考 OpenRouter 的 `data_collection` 选项)。

**9. 可选功能 (提升用户体验)：**

*   **模型信息显示：** 从 OpenRouter API 获取模型信息 (例如价格、速度、擅长领域等)，并在模型选择界面上显示，帮助用户做出更明智的决策。
*   **API 使用统计：** 显示用户使用 OpenRouter API 的统计信息，例如总请求数、总费用、平均延迟等。
*   **OpenRouter 账户管理：** 提供一个链接，方便用户跳转到 OpenRouter 官网管理他们的账户。
*    **在聊天界面显示当前正在使用的模型** 在生成回复后，在聊天记录中标记该条回复使用的是哪个模型。

**10. 测试：**

*   **单元测试：** 对关键模块进行单元测试，例如 API 请求构建、响应解析等。
*   **集成测试：** 进行集成测试，确保 OpenRouter 集成与其他功能模块能够协同工作。
*   **用户验收测试：** 邀请用户参与测试，收集反馈意见，并进行改进。
*   **模型列表获取测试：**
    *   确保能够正确调用 `List available models` API。
    *   确保能够正确解析 API 返回的 JSON 数据。
    *   确保能够在用户界面正确显示模型信息。
*   **缓存测试：**
    *   验证模型列表缓存功能是否正常工作。
    *   验证缓存失效时间是否正确。

**11. 部署：**

*   按照现有的 App 部署流程进行部署，需要和nodest的相关功能进行适配。
*   监控 API 调用情况，及时发现和解决问题。

**12. 日志：**

*   提供清晰可追溯的中文日志，方便开发者调试和定位具体问题。



























