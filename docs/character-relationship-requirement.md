
# 关系图谱设计

**核心思想：** 抽象地记录角色之间的关系，通过互动行为驱动关系演变和表现。

**目标：**

*   增强角色互动的深度和真实感。
*   提供更丰富的角色信息和关系概览。

## 一、 关系图谱构建

*   **数据结构：**
    *   每个角色维护一个关系图谱数据结构 (例如：邻接表/矩阵)。
    *   **关系强度：** 使用数值表示 (-100 到 100)。
    *   **关系类型：** 使用枚举类型或字符串常量 (例如：朋友、竞争对手、崇拜者、厌恶者)。

## 二、 关系图谱的作用及实现流程

### 2.1 现有基础 (朋友圈互动)

现有的朋友圈互动流程：

1.  构建朋友圈框架 (参考 `circle-interaction-system.md` )。
2.  根据互动类型选择朋友圈场景提示词。
3.  将整体信息发送给API，获得响应。
4.  将响应转化为角色的互动动作。

### 2.2 关系图谱的更新与应用

#### 2.2.1 消息盒子

*   **功能：** 每个角色维护一个消息盒子，作为朋友圈框架的 `chat history` 部分。
*   **作用：** 使角色了解近期收到的消息。
*   **刷新机制：** 设置存储消息上限，每天刷新1次，避免消息累积过多。

#### 2.2.2 状态检视提示词 (Relationship State Review Prompt)

*   **目标：** 命令角色检查消息盒子，并在输出中更新关系图谱。
*   **更新规则 (在提示词中)：**
    1.  频繁/积极的互动 (点赞、评论等)  -> 增加关系强度。
    2.  消极的互动 (批评、争吵等) -> 降低关系强度。
    3.  分析朋友圈内容和评论的情感色彩 (积极/消极)，并据此调整关系强度。
    4.  分析内容中提及的其他角色，根据情感色彩调整关系强度。
    5. **(条件触发)** 如果程序检测到当前关系强度达到预设阈值，则要求结合内容分析，输出新的关系类型.

#### 2.2.3 提示词与数据整合 (请求体)

*   **整合方式：**
    *   角色当前关系图谱数据和状态检视提示词，作为 `constant: true`, `depth: 1` 的D类条目插入。
    *   D类条目插入位置：以场景提示词 (视为用户消息) 为零点，根据插入深度规则插入 (参考 `nodest-architecture.md` 中 D类条目插入方法)。
*   **完整的请求体结构：**

    ```
    [朋友圈框架] char description  // 角色描述 (已实现)
    [朋友圈框架] char personality  // 角色人格 (已实现)
    [朋友圈框架] chat history       // 消息盒子内容
    [D类条目] relationship map     // 当前关系图谱数据
    [D类条目] relationship state review // 状态检视提示词
    [用户消息] scene prompt        // 场景提示词 (已实现)
    ```

#### 2.2.4 响应处理

*   **分割响应：**
    1.  用于 `newPost`, `replyToPost`, `replyToComment` 方法的 JSON 数据 (转化为朋友圈行为，已实现)。
    2.  响应中输出的最新的关系图谱，用于覆盖旧的关系图谱。
    3.  （如果存在新的关系类型）响应中输出的最新关系类型。
    
*  关系图谱更新，下次互动时生效。

## 三、 关系图谱呈现

*   **查看入口：**  `character` 页面设置独立的关系图谱页面入口。
*   **呈现方式：**
    *   以画布 (graph) 形式存储和展示。
    *   节点：代表角色。
    *   连线：代表角色1对角色2的关系和印象摘要。
    *   支持查看：关系强度、关系类型等详细参数。
*   **编辑功能：**
    *   支持手动修改关系图谱 (添加/删除节点和连线)。
    *   支持手动修改所有参数。
*   **操作流程：** 进入关系图谱 -> 选择角色 -> 可在画布上编辑。

## 四、 关系图谱对角色行为的影响

### 4.1 对朋友圈互动的影响

*   **正常互动：** 角色的评论/点赞/回复等行为会参考消息盒子和当前关系图谱 (因为状态检视提示词的存在)。
*   **初始互动：**
    *   优先参考 `character` 页面创建的初始图谱 (如果存在)。
    *   如果不存在初始图谱，则在初始互动时自动初始化一个。

### 4.2 行动触发

*   **触发条件：** 关系图谱的关系强度达到特定阈值。
*   **行动内容：** 角色对目标角色发动特定行动 (例如，赠送礼物)。
*   **呈现：**
    *   `explore` 页面新增一个页面标签，与朋友圈页面区分。
    *   UI 设计参考 RPG 游戏中角色交互的状态图表。
*   **效果：** 行动会反过来更新关系图谱。

### 4.3 关系类型更新

* **触发条件**： 角色发起互动行为时，程序检测到关系强度达到预设阈值.
* **触发方式**：状态检视提示词要求在响应中更新角色的关系类型。
*   **更新内容：** 新的角色关系类型，结合消息盒子和当前关系图谱来定义。

---

**关键点总结:**

*   **明确的数据结构:** 关系图谱、关系强度、关系类型。
*   **清晰的流程:** 消息盒子 -> 状态检视提示词 -> 请求体构建 -> 响应处理 -> 图谱更新。
*   **条理化的呈现:** 画布形式，可编辑，信息全面。
*   **明确的行为影响:** 影响朋友圈互动、触发特定行动、更新关系类型。
* **与现有系统结合:** 明确了与现有朋友圈框架和D类条目的集成方式.

