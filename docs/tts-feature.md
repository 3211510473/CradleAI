# 语音合成 (TTS) 功能指南

本文档介绍聊天界面中的文字转语音 (Text-to-Speech, TTS) 功能，包括使用方法、功能特点和技术实现。

## 功能概述

语音合成功能可以将角色的文本消息转换为语音输出，提供更加沉浸式的聊天体验。每个角色可以设置专属的语音模板，使其拥有独特的声音特征。

![TTS功能示意图](../assets/images/docs/tts-demo.png)

## 主要特性

- **角色专属语音**：每个角色可以通过设置独特的`voiceType`模板ID来使用不同的声音
- **语音表现力增强**：可以启用TTS增强器，通过AI分析文本并添加语气标记，使语音更加生动自然
- **持久化存储**：生成的语音会在设备上缓存，关闭应用后再次打开仍可使用，无需重新生成
- **直观状态反馈**：
  - 播放按钮：从未播放过的音频
  - 暂停按钮：正在播放中的音频
  - 重播按钮：播放完毕的音频
- **错误处理与重试**：生成失败时可以直接重试

## 使用方法

### 生成语音

1. 在聊天界面中，每条AI角色的消息右下角都有一个语音按钮
2. 点击语音按钮（扬声器图标）开始生成语音
3. 生成过程中会显示加载动画
4. 生成完成后自动开始播放

### 控制播放

- **播放/暂停**：点击播放按钮开始播放，再次点击暂停
- **重播**：音频播放完毕后，按钮会变为重播图标，点击即可从头开始播放
- **重试**：如果生成失败，会显示重试按钮，点击重新尝试生成

### TTS 增强功能

TTS增强功能可以显著提升生成语音的表现力和自然度：

1. 在设置中启用TTS增强器
2. 选择合适的LLM模型作为增强引擎（推荐使用Claude）
3. 启用后，系统会自动：
   - 分析文本情感和语境
   - 添加适当的语气标记（如强调、笑声、呼吸声等）
   - 生成情感引导指令以改善语音表现

## 技术实现

### 架构设计

TTS功能采用了服务单例模式实现，主要包含以下组件：

1. `ttsService.ts`：核心服务类，负责语音生成、播放控制和状态管理
2. `ChatDialog.tsx`：UI组件，负责显示语音按钮和状态交互

### 数据流向

```
用户点击 → ChatDialog组件 → ttsService服务 → TTS API → 获取音频 → 本地缓存 → 播放控制
```

### 增强语音流程

当启用TTS增强时，数据处理流程如下：

```
原始文本 → LLM分析 → 添加语气标记 → 生成情感指令 → API请求(task="Instructed Voice Generation") → 生成增强语音
```

### 状态持久化

语音状态使用AsyncStorage存储，包括：

- 已生成音频的本地URI
- 播放完成状态
- 使用的语音模板ID
- TTS增强器设置

这确保了即使应用重启，用户也能继续使用已生成的语音而无需重新生成。

### 按钮状态管理

```typescript
// 根据音频状态渲染不同的按钮图标
{audioState.isPlaying ? (
  // 播放中 - 显示暂停按钮
  <Ionicons name="pause" size={18} color="#fff" />
) : audioState.isComplete ? (
  // 播放完成 - 显示重播按钮
  <Ionicons name="refresh" size={18} color="#fff" />
) : (
  // 有音频但未播放 - 显示播放按钮
  <Ionicons name="play" size={18} color="#fff" />
)}
```

## 语音模板配置

每个角色可以在角色配置页面设置其`voiceType`属性，指定使用的语音模板ID。语音模板ID决定了生成的语音特性，如性别、语调、语速等。

```typescript
// 角色语音设置示例
{
  name: "爱丽丝",
  // ...其他属性
  voiceType: "female-soft-01"
}
```

如果角色未设置`voiceType`，则默认使用`template1`模板。

## 增强器语气标记

TTS增强器支持以下语气标记：

- `<strong></strong>`: 包裹需要强调的文本
- `<laughter></laughter>`: 表示笑声
- `[breath]`: 表示呼吸声或停顿

这些标记会被语音引擎解析，以产生更自然的语音表现。

## 故障排除

### 常见问题

1. **语音无法生成**
   - 检查网络连接
   - 确认TTS API服务是否可用
   - 检查API请求中的模板ID是否有效

2. **增强功能不工作**
   - 确认已在设置中启用TTS增强器
   - 检查选择的LLM模型是否可访问
   - 检查网络连接

3. **已生成的语音找不到了**
   - 可能是应用缓存被清理
   - 本地文件可能被删除或损坏

4. **播放按钮没有响应**
   - 尝试重新生成语音
   - 检查设备音频输出是否正常工作

### 错误处理

TTS服务内置了错误处理机制，会在UI上显示错误状态并提供重试选项。生成失败的具体原因会记录在日志中，方便开发人员排查问题。

## 开发者接口

ttsService提供了以下主要接口供开发者使用：

- `generateTTS(messageId, text, templateId)`: 为特定消息生成语音
- `playAudio(messageId)`: 播放或暂停特定消息的语音
- `getAudioState(messageId)`: 获取特定消息的语音状态
- `getEnhancerSettings()`: 获取当前TTS增强器设置
- `saveEnhancerSettings(settings)`: 保存TTS增强器设置
- `cleanup()`: 清理资源

## 后续计划

未来计划添加的功能和改进：

- 支持更多的语音模板选项
- 添加语速和音量控制
- 批量语音生成功能
- 更多语音情感表达选项
- 自定义语气标记规则
- 优化缓存策略，防止占用过多存储空间

---

*最后更新: 2025年4月17日*
