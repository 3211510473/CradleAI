总体流程：在摇篮模式选择标签，生成角色-用户尝试和摇篮角色聊一聊-用户有了修改意见后，可在摇篮页面和LLM通过对话，让LLM来修改角色数据，LLM修改角色后，会总结它的修改结果，这类似AI编程的流程。

详细流程：

1.在摇篮创建模式选择标签：摇篮模式创建角色简化为两部分的选项卡

（1）原有的外观选项卡，保持不动

（2）新增选择角色设定的选项卡，包括如下选项：你的性别，角色的性别，`特征`，角色的年龄范围。其中，所有的`特征`的选项在`vndb.json`中读取，并且需要转为中文表示。

（3）删掉其他的选项卡。

最终摇篮创建模式只会剩下两个选项卡，一个是外观，一个是角色设定。

`vndb.json`数据格式含有层级结构，你需要从UI UX层面思考，如何让用户方便地选择数量杂多的表情，并且保证应用的性能。












2.在摇篮模式创建角色后，根据用户创建角色时的输入，在vndb中检索，

第一次检索：

检索的过滤方式：

    -trait：即用户选择的特征

    -gender：即用户选择的角色性别
    
    -age：用户填写的角色年龄范围
    
    -vn：默认为如下过滤器----rating大于5.0分；has_description值为1；olang为"ja"或者"ch"


检索的字段的参数

   image.url,
   name,
   age,
   description：
   Personality：
   traits.role
   

检索结果数量设置

   results: 10


检索的响应参数：

    -result数组：包含了过滤后所有角色对象的检索字段



第二次检索：

检索的参数：第一次检索结果中，角色的vns



3.检索完毕后会立即调用角色生成器。此时的角色生成器向api的请求应该是这样：

【图片上传】如果有图片，这里向LLM上传一张图片，让LLM识图
.......等待LLM的回复
【vndb检索结果】从vndb返回的所有的检索结果，
.......等待LLM的回复
【指令提示词】需要一条合适的指令，让LLM根据识图结果和vndb检索结果来生成角色的设定信息。例如


```
基于识图结果和vndb检索结果生成角色设定，确保生成的角色设定足够丰满、生动、有趣。 模型需要具备：
角色塑造: 基于归纳总结，构建角色的性格、背景故事、技能、外貌特征等。
故事叙述: 能够将角色的设定融入到一段引人入胜的故事情节中。
风格迁移: 根据用户的喜好，调整角色的写作风格 (例如，幽默、严肃、史诗、科幻等)。
细节刻画: 加入一些细节，让角色更加真实。 比如，角色的口头禅、习惯动作、特殊爱好等。

回复格式要求  ///（与character-generator-service中的相同，json格式）

```

另外，Gemini和openrouter的图片发送请求体：

```
//Gemini


```


```
//openrouter示例
const request: Request = {
  messages: [
    {
      role: 'user',
      content: [
        {
          type: 'text',
          text: '请描述这张图片的内容。'
        },
        {
          type: 'image_url',
          image_url: {
            url: imageUrl,
            detail: 'high' // Optional: 'auto', 'low', 'high'
          }
        }
      ] as ContentPart[], // 类型断言 ContentPart[]
    } as Message, // 类型断言 Message
  ],
  model: 'openai/gpt-4-vision-preview', // 确保选择支持图像的模型
  max_tokens: 500,
  temperature: 0.7,
};

```

4.在角色设定输出完成后，才会更新characterscontext，并且创建出角色的完整信息。


5.但是因为生图请求的需要，在点击角色创建按钮之后，就要立刻cradle页面创建角色的卡片，这一点和原流程相同。这样，卡片就可以及时被生成的图片填充


6.角色被完整创建后，用户会正常和角色聊天，感受一下是否合适


7.用户可以回到cradle页面，和摇篮助手进行对话，摇篮系统会根据用户的对话输入来修改角色的性格。





检索过滤器包括

    -默认maincharacter

    -默认hasdescription

    -默认作品rating大于5

    -personality，
  
    -角色的年龄

    -对vn的偏好：原始语言（中日韩）？背景tag？
  
返回内容包括
    
    -角色名字
        
    -角色描述

    -对应的vn描述    

注意：检索到的角色是基于故事背景来创造的，而不一定符合用户的喜好，它的作用是为LLM提供各种要素和灵感，让人物和背景故事更丰富。



LLM输出：


如果没有检索到结果，应该基于用户投喂直接生成角色，而不是报错。

如果用户没有投喂，则不生成角色

返回信息应包括所有角色字段。

筛选has description的角色

根据：用户输入的personality，对vn的语言偏好，tag偏好，进行过滤

返回信息应包括图片，以帮助llm读图，这是因为有些角色的介绍不全，但其个性可以从图片推断出更多的信息。

角色的vn信息也需要获取，这有助于LLM构建设定，参考角色不能脱离其故事背景


对每个环节的错误和中断实现良好的重试机制和清晰的中文日志。






信息分类，把信息分类为各种D类条目，来写作Alist，Plist，backgroundstory

   -首先是推理和整理需求，根据需求来映射到vndb的检索参数

   -对返回的内容进行参考并结合投喂的信息

   -产出chardescription，charpersonality和各种D类条目，

   -chardescription和对话示例的R类条目由Alist和Plist进行内容的填充





1.我需要创建的角色生成器是这样一个流程：它必须先整理“消息盒子”，“消息盒子”是一种用户输入给生成器的，各种不同类别的信息，每一类信息是杂乱的，投喂的，它需要得到用户自己的信息，用户的爱好，用户提供的参考素材，综合这几个方面，来输出出一个符合角色数据格式的结果。可以看出，角色生成器的理念是把用户的任何零碎念头进行统合，为他生成一个他想要的虚拟角色。

并且，它是一个迭代前进的过程，即它会阶段性地生成角色设定，并且下一阶段的生成要参考上一阶段的生成结果

再有，从用户体验的角度来说，应该允许阶段性查看和干预结果，中断进程清空记忆重来，正如AI编程允许打断进程一样。

它需要这样的技术：

1.有一个擅长归纳多个类别的消息的模型，且每个类别之消息前后可能毫无关联性的消息。因此，它需要推理，因为如果不思考，从表面毫无关联性的消息进行归纳输出，结果很可能是低质量的。

2.有一个上下文充沛和写作文学作品能力强的模型，来处理模型1.所输出的归纳总结。

3.它接入一个功能强大的搜索引擎，可以基于如下的规则搜索