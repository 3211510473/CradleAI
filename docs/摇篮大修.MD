总体流程：在摇篮模式选择标签，生成角色-用户尝试和摇篮角色聊一聊-用户有了修改意见后，可在摇篮页面和LLM通过对话，让LLM来修改角色数据，LLM修改角色后，会总结它的修改结果，这类似AI编程的流程。



1.在摇篮模式点击创建角色后，除了触发向服务器请求生成图片之外，还需要根据用户创建角色时的输入，在vndb中进行检索


检索的过滤方式filter
```
    -traits：即用户选择的特征

    -gender：即用户选择的角色性别
    
    -age：用户填写的角色年龄范围
    
    -vn：默认为如下过滤器----rating大于5.0分；has_description值为1；olang为"ja"或者"ch"
```

检索字段的参数field
```
   image.url
   name
   age,
   description：
   Personality：
   traits.role
```
检索结果数量设置result
```
   results: 10
```

检索的响应response

    -一个result数组：包含了过滤后的所有角色对象的检索字段

vndb的接口规范：


```



```

详情可参见VNDB文档















先实现：点击创建按钮进行上述的查询流程，然后我会提出进一步的开发需求。




3.检索完毕后会立即调用`character-generator-service.tsx`。此时的角色生成器向api的请求应该是这样：

【图片上传】如果有图片，这里向LLM上传一张图片，让LLM识图
.......等待LLM的回复
【vndb检索结果】从vndb返回的所有的检索结果，
.......等待LLM的回复
【指令提示词】需要一条合适的指令，让LLM根据识图结果和vndb检索结果来生成角色的设定信息。例如


```
基于识图结果和vndb检索结果生成角色设定，确保生成的角色设定足够丰满、生动、有趣。 模型需要具备：
角色塑造: 基于归纳总结，构建角色的性格、背景故事、技能、外貌特征等。
故事叙述: 能够将角色的设定融入到一段引人入胜的故事情节中。
风格迁移: 根据用户的喜好，调整角色的写作风格 (例如，幽默、严肃、史诗、科幻等)。
细节刻画: 加入一些细节，让角色更加真实。 比如，角色的口头禅、习惯动作、特殊爱好等。

回复格式要求  ///（与character-generator-service中的相同，json格式）
```

4.在角色设定输出完成后，才会更新characterscontext，并且创建出角色的完整信息。


5.但是因为生图请求的需要，在点击角色创建按钮之后，就要立刻cradle页面创建角色的卡片，这一点和原流程相同。这样，卡片就可以及时被生成的图片填充。在角色设定没有生成之前，卡片应该显示一种正在加载设定状态


6.角色被完整创建后，用户会正常和角色聊天，感受一下是否合适


7.用户可以回到cradle页面，和摇篮助手进行对话，摇篮系统会根据用户的对话输入来修改角色的性格。


另外注意

LLM输出：

1.因为vndb的api不一定稳定，需要合适的重试机制和最大重试次数。


2.如果因为各种原因实在没有检索到结果，用户可以重试，或者创建一个设定为空的摇篮角色，并自己命名。





信息分类，把信息分类为各种D类条目，来写作Alist，Plist，backgroundstory

   -首先是推理和整理需求，根据需求来映射到vndb的检索参数

   -对返回的内容进行参考并结合投喂的信息

   -产出chardescription，charpersonality和各种D类条目，

   -chardescription和对话示例的R类条目由Alist和Plist进行内容的填充












