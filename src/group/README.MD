# 群聊功能模块

## 概述

群聊功能模块提供了一套完整的解决方案，允许用户创建群组并邀请AI角色加入，形成多角色互动的群聊场景。该模块基于朋友圈系统的架构设计，将社交互动从一对多的异步形式扩展到多对多的实时对话形式。

## 核心功能

- **群组创建与管理**：用户可以创建群聊，设置主题，添加或移除AI角色成员
- **多角色聊天**：支持多个AI角色在同一对话空间中互动
- **角色自然互动**：AI角色可以互相@提及，评估并响应其他角色的消息
- **历史上下文**：每个角色的回复会考虑之前的群聊记录，确保对话连贯性
- **私聊关联**：角色在群聊中的回复会参考与用户的私聊记录，保持人格一致性
- **对话调度系统**：有序管理多角色回复，模拟真实群聊节奏
- **定时消息功能**：角色会在用户不活跃时按照设定的时间间隔自动发送消息，保持群聊活跃度

## 架构设计

群聊功能由四个主要组件构成：

1. **GroupService**：群聊核心服务层，处理群组创建、消息发送和角色回复
2. **GroupManager**：用户接口层，提供易于使用的API，管理用户与群组的交互
3. **GroupScheduler**：调度系统，处理多角色回复的顺序和频率，管理定时消息发送
4. **群类型定义**：提供清晰的类型定义，确保代码一致性和可维护性

### 数据流

1. 用户通过`GroupManager`创建群组或发送消息
2. `GroupService`处理请求，持久化存储消息
3. `GroupScheduler`安排角色回复，管理角色响应顺序和定时触发逻辑
4. AI角色生成回复内容，可能@其他角色
5. 被@的角色收到提醒，评估并可能作出进一步回复
6. 在无用户活动时，定时器触发角色主动发送消息

## 前端集成现状

当前群聊功能已成功集成到前端界面中，主要包括以下几个方面：

1. **对话窗口列表**：
   - 用户可以在Sidebar中查看所有私聊和群聊对话
   - 群聊显示有特殊标识和成员头像集合视图
   - 支持群聊和私聊间无缝切换

2. **群聊创建功能**：
   - Sidebar中添加了"创建群聊"按钮
   - 创建时可指定群聊名称、主题和初始成员
   - 选择界面显示所有可添加的角色

3. **群聊体验**：
   - 群聊窗口自动加载历史消息
   - 用户消息会自动触发角色回复，模拟真实群聊
   - 消息按时间顺序显示，包括系统通知

4. **群聊管理**：
   - TopBar显示群聊信息和管理按钮
   - 支持添加/移除群聊成员
   - 群组管理模式包括成员列表和成员管理
   - 自定义群聊设置，包括定时消息间隔、每日消息限制等

5. **用户界面适配**：
   - 群聊与私聊使用不同的输入组件（GroupInput vs ChatInput）
   - 群聊与私聊使用不同的对话组件（GroupDialog vs ChatDialog）
   - 界面过渡平滑，提供良好用户体验

6. **定时消息系统**：
   - 支持在用户不活跃时角色自动发送消息
   - 每个角色有独立的定时计时器
   - 即使用户退出群聊界面，定时消息也会持续工作
   - 支持自定义消息间隔时间

## 关键技术

- **NodeST集成**：利用NodeST的`generateContent`方法生成高质量角色回复
- **提示工程**：精心设计的提示模板，确保角色行为自然且符合人设
- **异步存储**：使用AsyncStorage存储群组数据和消息历史
- **调度算法**：智能调度角色回复，保持对话自然节奏
- **上下文管理**：将群聊历史和私聊记录结合，生成连贯对话
- **持久化机制**：确保群聊设置和回复状态在应用重启后依然保持
- **后台处理**：即使用户不在当前页面，也能保持消息发送机制正常工作

## 使用示例

### 创建群聊

```typescript
import { createUserGroup } from '@/src/group';

// 创建一个新群聊
const newGroup = await createUserGroup(
  currentUser,
  "AI绘画交流群",
  "分享AI绘画技巧和作品",
  [character1, character2, character3]
);
```

### 发送消息

```typescript
import { sendGroupMessage } from '@/src/group';

// 向群组发送消息
const message = await sendGroupMessage(
  currentUser,
  groupId,
  "大家好，我最近生成了一些AI画作，大家觉得怎么样？"
);
```

### 获取群聊列表

```typescript
import { getUserGroups } from '@/src/group';

// 获取用户参与的所有群聊
const userGroups = await getUserGroups(currentUser);
```

### 获取群聊消息

```typescript
import { getGroupMessages } from '@/src/group';

// 获取特定群聊的所有消息
const messages = await getGroupMessages(groupId);
```

### 设置群聊参数

```typescript
import { updateGroupSettings } from '@/src/group';

// 更新群聊设置
updateGroupSettings(groupId, {
  dailyMessageLimit: 50,
  replyIntervalMinutes: 2.5, // 设置2.5分钟的回复间隔
  referenceMessageLimit: 5
});
```

## 角色交互逻辑

群聊中的角色交互遵循以下规则：

1. **回复链条**：
   - 第一个角色：参考群聊主题和用户消息
   - 第二个角色：参考第一个角色的回复、群聊主题和用户消息
   - 后续角色：参考之前所有角色的回复、群聊主题和用户消息

2. **@机制**：
   - 角色可以@其他角色
   - 被@的角色会评估是否需要回复
   - 如果决定回复，会@回原角色

3. **限制机制**：
   - 每日消息数量限制
   - 回复时间间隔限制
   - 参考消息数量限制

4. **定时消息**：
   - 角色会在指定时间间隔后检查是否需要发送新消息
   - 时间间隔可在群组设置中自定义
   - 定时消息会考虑群聊上下文，生成自然的对话延续
   - 即使用户不在群聊界面，定时消息机制也会正常运行

## 扩展与定制

群聊模块设计灵活，可以通过以下方式扩展：

1. **添加消息类型**：扩展`GroupMessage`接口支持更多消息类型
2. **调整提示模板**：修改`buildGroupReplyPrompt`方法定制角色行为
3. **增强调度算法**：自定义`GroupScheduler`的调度逻辑
4. **增加用户控制**：实现更多群组设置和用户控制选项
5. **定制定时策略**：定制角色的定时发言行为和频率

## 约束条件

- 每个角色每日最多发送50条消息（可自定义）
- 每个角色两次连续回复间隔至少1分钟（可自定义）
- 每个角色最多参考5条之前的消息（可自定义）

## 未来改进方向

- 支持图片和多媒体消息
- 实现更复杂的群组权限系统
- 添加角色情绪追踪系统
- 实现群组活动和事件功能
- 支持群组语音聊天
- 优化移动端UI组件，提升用户体验
- 增强错误处理和消息重发机制
- 添加群聊消息搜索功能
- 增加更多定时消息配置选项，如角色特定设置和基于时间段的发言频率
